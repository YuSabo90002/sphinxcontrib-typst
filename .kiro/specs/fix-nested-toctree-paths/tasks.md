# 実装タスク: ネストされたtoctreeの相対パス修正

## タスク概要

このドキュメントは、Issue #5（ネストされたtoctreeの相対パス生成問題）の修正に必要な実装タスクを定義します。タスクは順序立てて実行され、各タスクは前のタスクの成果物を基に構築されます。

---

## 実装タスク

- [x] 1. 相対パス計算ロジックの実装
- [x] 1.1 プライベートヘルパーメソッドの追加
  - 現在のドキュメントの位置を取得する機能を実装
  - ターゲットドキュメントへの相対パスを計算する機能を実装
  - 同じディレクトリ内の参照に対してファイル名のみを返す処理を実装
  - 異なるディレクトリツリー間の相対パスを計算する処理を実装（共通の親ディレクトリを経由）
  - PurePosixPathを使用してOS非依存なパス計算を保証
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 1.2 既存のtoctree処理メソッドの修正
  - toctreeノード訪問時に現在のドキュメント名を取得する処理を追加
  - 各toctreeエントリに対して相対パス計算を呼び出す処理に変更
  - ルートディレクトリからの参照で既存の動作を維持する条件分岐を実装
  - エラーハンドリングとフォールバック処理を追加（絶対パスへのフォールバック）
  - 警告ログ出力機能を実装（Sphinx loggingシステム使用）
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3_

- [x] 2. ユニットテストの実装
- [x] 2.1 相対パス計算ロジックのテスト作成
  - 同じディレクトリ内のドキュメント参照をテスト（例: chapter1/index → chapter1/section1）
  - 親ディレクトリへの参照をテスト（例: chapter1/section1 → index）
  - 兄弟ディレクトリ間の参照をテスト（例: chapter1/doc → chapter2/doc）
  - ネストされたサブディレクトリへの参照をテスト（例: chapter1/index → chapter1/sub/doc）
  - 深いネストレベルでの相対パス計算をテスト（例: a/b/x/y → a/b/c/d/e）
  - current_docnameがNoneの場合のフォールバック動作をテスト
  - ルートドキュメントからの参照でdocnameをそのまま返すことをテスト
  - PurePosixPathのクロスプラットフォーム動作を検証（Windows環境でも/区切りを使用）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 5.1_

- [x] 2.2 エラーハンドリングのテスト作成
  - ValueError発生時の共通親ディレクトリ経由のパス構築をテスト
  - 予期しない例外発生時のフォールバック動作をテスト
  - 警告ログが適切に出力されることを検証（注: 現在の実装ではすべてのケースが正常に処理されるため、実際のエラーログは発生しない）
  - _Requirements: 1.5, 5.1_

- [x] 3. 統合テストフィクスチャの作成
- [x] 3.1 Issue #5再現フィクスチャの作成
  - ルートディレクトリにindex.rstを配置（toctree: chapter1/index）
  - chapter1ディレクトリにindex.rst、section1.rst、section2.rstを配置
  - chapter1/index.rstでsection1とsection2をtoctree参照する構造を作成
  - conf.pyでsphinxcontrib-typstビルダーを設定
  - _Requirements: 3.1, 5.1_

- [x] 3.2 複数レベルネストフィクスチャの作成
  - 3階層のディレクトリ構造を作成（root → part1 → chapter1）
  - 各レベルでtoctree参照を設定
  - 深いネストでの相対パス生成を検証できる構造を実装
  - _Requirements: 3.2, 5.1_

- [x] 3.3 兄弟ディレクトリ参照フィクスチャの作成
  - chapter1とchapter2の2つの兄弟ディレクトリを作成
  - chapter1/doc1.rstからchapter2/doc2への参照を設定
  - クロスディレクトリ参照での相対パス生成を検証できる構造を実装
  - _Requirements: 3.2, 5.1_

- [x] 4. 統合テストの実装
- [x] 4.1 Issue #5再現テストの実装
  - フィクスチャプロジェクトでSphinxビルドを実行
  - chapter1/index.typに`#include("section1.typ")`が生成されることを検証
  - chapter1/index.typに`#include("section2.typ")`が生成されることを検証
  - index.typに`#include("chapter1/index.typ")`が生成されることを検証
  - _Requirements: 3.1, 3.3, 5.2_

- [x] 4.2 複数レベルネストテストの実装
  - 3階層フィクスチャでSphinxビルドを実行
  - part1/chapter1/index.typに正しい相対パスが生成されることを検証
  - 各レベルのtoctreeで適切な相対パス形式が使用されることを確認
  - _Requirements: 3.2, 3.3, 5.1_

- [x] 4.3 兄弟ディレクトリ参照テストの実装
  - 兄弟ディレクトリフィクスチャでSphinxビルドを実行
  - chapter1/doc1.typに`#include("../chapter2/doc2.typ")`が生成されることを検証
  - クロスディレクトリパスが正しく計算されることを確認
  - _Requirements: 3.2, 3.3, 5.2_

- [x] 5. E2Eコンパイルテストの実装
- [x] 5.1 Typstコンパイル検証テストの追加
  - 統合テストフィクスチャで生成されたTypstファイルをtypst-pyでコンパイル
  - コンパイルが成功することを検証（returncode == 0）
  - 生成されたPDFファイルが存在することを確認
  - typst-pyが利用できない環境ではスキップする設定を追加
  - _Requirements: 4.1, 4.2, 4.3, 5.3_

- [x] 5.2 クロスプラットフォームコンパイル検証
  - Linux、macOS、Windowsの各環境でコンパイルテストが実行されることを確認
  - CI/CD設定でmatrix strategyを使用した複数環境テストを設定
  - 各プラットフォームでPurePosixPathが正しくPOSIX形式パスを生成することを検証
  - _Requirements: 4.3, 5.3_
  - Note: PurePosixPath使用により全プラットフォームでPOSIX形式パス生成を保証

- [x] 6. 既存機能の回帰テスト実行
- [x] 6.1 既存テストスイートの実行と検証
  - 既存の286テストケースすべてを実行
  - すべてのテストがパスすることを確認
  - テスト失敗がある場合、修正が後方互換性を破壊していないか検証
  - _Requirements: 2.1, 2.2, 2.3, 5.2_

- [ ] 6.2 コードカバレッジの検証
  - pytest-covでコードカバレッジを測定
  - 93%以上のカバレッジが維持されていることを確認
  - 新規追加コードが適切にカバーされていることを検証
  - カバレッジ不足がある場合、追加テストケースを実装
  - _Requirements: 5.2_

- [ ] 7. ドキュメンテーションとログの実装
- [ ] 7.1 デバッグログの追加
  - 相対パス計算の各ステップでデバッグレベルログを出力
  - current_docname、target_docname、計算された相対パスをログに記録
  - デバッグ時の追跡可能性を向上
  - _Requirements: 1.3_

- [ ] 7.2 コードコメントとdocstringの追加
  - プライベートヘルパーメソッドにdocstringを追加（引数、戻り値、例外の説明）
  - 複雑なロジック（異なるディレクトリツリー間のパス計算）にインラインコメントを追加
  - 使用例をdocstringに含める
  - _Requirements: すべての要件（保守性向上）_

---

## 実装ガイドライン

### 実装順序
タスクは上から順に実装してください。各タスクは前のタスクの成果物を利用します。

### テスト駆動開発
- タスク2（ユニットテスト）を実装してからタスク1（コアロジック）を実装するTDDアプローチも推奨
- 各機能実装後、対応するテストが即座にパスすることを確認

### コミットポイント
以下のタスク完了後にコミットを推奨：
- タスク1完了後: 相対パス計算ロジックの実装
- タスク2完了後: ユニットテスト実装
- タスク4完了後: 統合テスト実装
- タスク6完了後: 回帰テスト検証

### 品質チェック
各タスク完了時に以下を確認：
- [ ] 既存テスト286件がすべてパス
- [ ] 新規テストがパス
- [ ] コードカバレッジ93%以上を維持
- [ ] 型チェック（mypy）がパス
- [ ] リンター（ruff）が警告なし

---

## 成功基準

すべてのタスクが完了し、以下の条件を満たした場合、実装は成功とみなされます:

1. ✅ Issue #5のテストケースがパス
2. ✅ 既存の286テストがすべてパス
3. ✅ コードカバレッジ93%以上を維持
4. ✅ 新規統合テストがパス（3フィクスチャ）
5. ✅ Typstコンパイルテストがパス（PDF生成成功）
6. ✅ クロスプラットフォームテストがパス（Linux/macOS/Windows）
